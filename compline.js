$(function(e){"use strict";function t(t,a){var n=e("a[toggle="+t+"]");switch("undefined"==typeof a&&(a=v[t]()),n.text(n.attr("toggle-"+a.toString())),t){case"autoSelectRegion":e("#selectRegion").prop("disabled",a);break;case"fullNotationPrayers":e(".notated-prayer").toggle(a),e(".pointed-prayer").toggle(!a)}}function a(){e.getJSON("https://freegeoip.net/json/",function(e){if(e.country_code in romanCalendar.regionCodeMap)k(e.country_code);else{var t=e.country_code+"-"+e.region_code;t in romanCalendar.regionCodeMap?k(t):console.info("Unknown Region:",e)}console.info("Country: "+e.country_name+"\nCode: "+e.country_code),window.ipGeo=w=e})}function n(e){var t=Math.floor(e/100),a=e-19*Math.floor(e/19),n=Math.floor((t-17)/25),r=t-Math.floor(t/4)-Math.floor((t-n)/3)+19*a+15;r-=30*Math.floor(r/30),r-=Math.floor(r/28)*(1-Math.floor(r/28)*Math.floor(29/(r+1))*Math.floor((21-a)/11));var i=e+Math.floor(e/4)+r+2-t+Math.floor(t/4);i-=7*Math.floor(i/7);var o=r-i,s=3+Math.floor((o+40)/44),l=o+28-31*Math.floor(s/4);return moment([e,s-1,l])}function r(e){for(var t=s(e),a=0;a<CalendarSundays.length;++a){var n=CalendarSundays[a];if(n.on){if(e.isSame(c(n.on,e)))return SundayFeast(n,e,t)}else if(n.before){if(e.isBefore(c(n.before,e)))return SundayFeast(n,e,t)}else if(n.after&&e.isAfter(c(n.after,e)))return SundayFeast(n,e,t)}}function i(e,t){e&&!e.length&&(e=void 0);var a={title:"Feria",rank:10},n=a;return e&&e.length&&(e.unshift(a),t?(n=t,f=n.region[0]):f="",n.alternates=e),n}function o(t){if("liturgical"in t)return t.liturgical;if(0===t.day())return t.liturgical=r(t);if(u(t,"corpusChristi"))return t.liturgical={title:"Corpus Christi",rank:1};if(u(t,"sacredHeart"))return t.liturgical={title:"The Most Sacred Heart of Jesus",rank:1};if(u(t,"ascension"))return t.liturgical={title:"The Ascension of Our Lord",rank:1};if(u(t,"easter-3"))return t.liturgical={title:"Maundy Thursday",rank:1};if(u(t,"easter-2"))return t.liturgical={title:"Good Friday",rank:1};if(u(t,"easter-1"))return t.liturgical={title:"Holy Saturday",rank:1};if(u(t,"lent1-4"))return t.liturgical={title:"Ash Wednesday",rank:5};var a,n=[];if(regionalCalendars){var o=t.format("MM/DD"),s=moment(t).subtract(1,"day").format("MM/DD");e.each(regionalCalendars,function(r,i){var l;if(o in i)l=i[o];else if(s in i){var c=i[s];"ifSunday"===c.plusOne&&1===t.day()&&(l=c)}if(l){var u=r===f||romanCalendar.regionCodeMap[h.region]===r;l.region=[r];var d=e.grep(n,function(e,t){return e.title==l.title&&e.rank===l.rank});d.length?(d[0].region.push(r),u&&(a=d[0])):(n.push(l),u&&(a=l))}})}if(romanCalendar){var l=t.month(),c=t.date(),d=romanCalendar[l][c];if(!d&&c>1){if(d=romanCalendar[l][c-1],!d||!d.plus)return t.liturgical=i(n,a);if("ifLeapYear"===d.plusOne&&!t.isLeapYear())return t.liturgical=i(n,a);if("ifSunday"===d.plusOne&&1!==t.day())return t.liturgical=i(n,a)}if(n.length&&(n.unshift(d),a?(d=a,f=d.region[0]):f="",d.alternates=n),d)return t.liturgical=d}return t.liturgical=i(n,a)}function s(e){return e.Dates||(e.Dates=new C(e.year()))}function l(e,t,a){if(t[1])return moment([e.year(),parseInt(t[2])-1,parseInt(t[3])]);if(t[5]in a){var n=a[t[5]]||[0];if("function"==typeof n)return a[t[5]](e);var r=moment(n);if(t[7]){var i=parseInt(t[7])||0;"-"==t[6]&&(i*=-1),r.add(i,"days")}return r}return console.info("date not found: "+t[5]),moment("")}function c(e,t){var a=s(t),n=/(?:((\d\d)\/(\d\d))|((\w+)(?:([+-])(\d+))?))(?::(((\d\d)\/(\d\d))|((\w+)(?:([+-])(\d+))?)))?/g,r=n.exec(e);return l(t,r,a)}function u(e,t){for(var a,n,r=s(e),i=/(!)?(?:((\d\d)\/(\d\d))|((\w+)(?:([+-])(\d+))?))(?::(((\d\d)\/(\d\d))|((\w+)(?:([+-])(\d+))?)))?/g;a=i.exec(t);){var o=a[1],c=[l(e,a.slice(1),r)];if(a[9]){if(c.push(l(e,a.slice(9),r)),n=e.isBetween(c[0],c[1],"day","[]"),o&&(n=!n),n)return!0}else if("boolean"==typeof c[0]){if(o&&(c[0]=!c[0]),c[0])return!0}else if(n=e.isSame(c[0],"day"),o&&(n=!n),n)return!0}return!1}function d(){var t=S();e("input:radio:not(.not-hideable)").parent().toggle(t),e("#marian-antiphon-choices>select").toggle(t),e(".marian-antiphon-name").toggle(!t),t||e("input:radio:checked").parent().show()}var f="",h=window.localStorage;try{var p="__storage test__";h.setItem(p,p),h.removeItem(p)}catch(g){h={}}"region"in h||(h.region=""),"fullNotation"in h||(h.fullNotation="0"),"fullNotationPrayers"in h||(h.fullNotationPrayers="0"),"showOptions"in h||(h.showOptions="0"),"autoSelectRegion"in h||(h.autoSelectRegion="1");var m={};e("#selectRegion").append('<option value="">None</option>'+Object.keys(romanCalendar.regionCodeMap).map(function(e){var t=romanCalendar.regionCodeMap[e];return t in m?"":(m[t]="",'<option value="'+e+'"">'+t+"</option>")}).join("")).val(h.region);var y=e("#options-menu");e(document.body).click(function(t){var a=e(t.target);a.parents().is(y)?a.is("a,input,select")||y.toggleClass("showing"):y.removeClass("showing")});var v={},b=v.fullNotation=function(e){return"undefined"==typeof e?!!parseInt(h.fullNotation):(t("fullNotation",!!e),h.fullNotation=e?1:0,Y(),void x())},S=(v.fullNotationPrayers=function(e){return"undefined"==typeof e?!!parseInt(h.fullNotationPrayers):(t("fullNotationPrayers",!!e),void(h.fullNotationPrayers=e?1:0))},v.showOptions=function(e){return"undefined"==typeof e?!!parseInt(h.showOptions):(t("showOptions",!!e),h.showOptions=e?1:0,void d())}),k=(v.autoSelectRegion=function(e){return"undefined"==typeof e?!!parseInt(h.autoSelectRegion):(t("autoSelectRegion",!!e),h.autoSelectRegion=e?1:0,void(e&&a()))},function(t){return"undefined"==typeof t?!!parseInt(h.autoSelectRegion):(e("#selectRegion").val(t),f="",void(h.region=e("#selectRegion").val()))});e("a[href][toggle]").click(function(t){t.preventDefault();var a=e(this),n=v[a.attr("toggle")];n(!n())}),e("#selectRegion").change(function(t){k(e(this).val())}),e.each(v,function(e){t(e)});var w;parseInt(h.autoSelectRegion)&&a();var M={},C=function(e){return e in M?M[e]:(this.year=e,this.easter=n(e),this.septuagesima=moment(this.easter).subtract(63,"days"),this.lent1=moment(this.septuagesima).add(21,"days"),this.ascension=moment(this.easter).add(39,"days"),this.pentecost=moment(this.easter).add(49,"days"),this.christmas=moment([e,11,25]),this.advent1=moment(this.christmas).subtract((this.christmas.day()||7)+21,"days"),this.allSouls=moment([e,10,2]),0===this.allSouls.day()&&this.allSouls.add(1,"day"),this.corpusChristi=moment(this.pentecost).add(11,"days"),this.sacredHeart=moment(this.pentecost).add(19,"days"),this.christTheKing=moment([e,9,31]),this.christTheKing.subtract(this.christTheKing.day(),"days"),this.sevenDolors=moment([e,8,15]),this.epiphany=moment([e,0,6]),this.holyFamily=moment(this.epiphany).add(7-(this.epiphany.day()||1),"days"),this.transfiguration=moment([e,7,6]),void(M[e]=this))};C.prototype.firstClassFeast=function(e){var t=o(e);return!(!t||1!==t.rank)},C.prototype.firstOrSecondClassFeast=function(e){var t=o(e);return!(!t||1!==t.rank&&2!==t.rank)},C.prototype.feastOfOurLady=function(e){var t=o(e);return!(!t||!t.ol)},C.prototype.minorFeast=function(e){var t=o(e);return t&&t.rank>1&&t.rank<5},C.prototype.feria=function(e){var t=o(e);return 0!==e.day()&&(!t||t.rank>=5)},C.prototype.sunday=function(e){return 0===e.day()},C.prototype.isTriduum=function(e){var t=moment(this.easter).subtract(3,"days");return e.isSameOrAfter(t)&&e.isBefore(this.easter)},C.prototype.isPaschalWeek=function(e){var t=moment(this.easter).add(6,"days");return e.isSameOrAfter(this.easter)&&e.isBefore(t)},C.prototype.isPaschalTime=function(e){var t=moment(this.easter).add(55,"days");return e.isSameOrAfter(this.easter)&&e.isBefore(t)},C.prototype.isAdvent=function(e){return e.isSameOrAfter(moment(this.advent1).subtract(1,"day"))&&e.isSameOrBefore(moment(this.christmas).subtract(1,"day"))},window.momentFromString=c,e.QueryString=function(e){if(""===e)return{};for(var t={},a=0;a<e.length;++a){var n=e[a].split("=");2==n.length&&(t[n[0]]=decodeURIComponent(n[1].replace(/\+/g," ")))}return t.successMsg&&showAlert(!1,t.successMsg),t.failMsg&&showAlert(!0,t.failMsg),t}(window.location.search.substr(1).split("&"));var O=moment();e("#date").val(O.format("YYYY-MM-DD"));var D=function(e){return function(t,a){var n=moment(a);return n.isValid()?n.add(e,"days"):n=moment(),n.format("YYYY-MM-DD")}},I=function(t){e("#date").val(D(t?7:1)).change()},T=function(t){e("#date").val(D(t?-7:-1)).change()};e(document).on("keypress",function(e){switch(e.which){case 106:case 74:T(e.shiftKey);break;case 107:case 75:I(e.shiftKey)}});var F,N=O.day(),R=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];if(e.QueryString.day){var P=e.QueryString.day;P in R?N=P:(P=R.indexOf(P),P in R&&(N=P))}var _="",x=function(t){t=t||_.replace(/_full$/,"");var a=t;if(b()&&(t+="_full"),t!==_){_=t;var n="<chant-gabc src='canticle-ant"+a+".gabc'></chant-gabc>";"-pt"===a&&(a="",t=t.slice(3));var r="<chant-gabc src='canticle-psalm"+t+".gabc'></chant-gabc>",i=function(t){var i=n+r+t;i+="-po"===a?"<chant-gabc src='haec-dies.gabc'></chant-gabc>":n,e("#canticle").empty().append(i)};e("#canticle").empty(),b()?i(""):e.get("canticle-psalm"+t+".html",i)}},A={},Y=function(t,a,n){if("undefined"==typeof t?(t=A.day,a=A.paschalTime,n=A.isSunday):(A.day=t,A.paschalTime=a,A.isSunday=n),!("undefined"==typeof t&&"undefined"==typeof a&&"undefined"==typeof n||A.day==t&&A.paschalTime==a&&A.isSunday==n&&A.full==b())){A.fullNotation=b();var r="",i="",o="",s=b()?"_full":"";"triduum"===t?(t=0,o="-triduum",s=""):"asd"===t?(o="",i="<chant-gabc src='psalms/"+t+"/psalm"+o+s+".gabc'></chant-gabc>"):(o=a?"-PT":"",r=a?"<chant-gabc src='psalms/ant-PT.gabc'></chant-gabc>":"<chant-gabc src='psalms/"+t+"/ant.gabc'></chant-gabc>","no-antiphon"===a&&(r=""),i="<chant-gabc src='psalms/"+t+"/psalm"+o+s+".gabc'></chant-gabc>",F=R[t],n||e("#weekday").text(F));var l=function(t){var a=r+i+t+r;e("#placeholder").empty().append(a)};s?l(""):e.get("psalms/"+t+"/psalm-verses"+o+".html",l).fail(function(){e.get("psalms/"+t+"/psalm-verses.html",l)})}},B=function(e){switch(e){case 1:return"I Class";case 2:return"II Class";case 3:return"III Class";case 5:return"Commemoration";default:return"Feria"}},j=function(t,a){var n=s(t),r=o(t,a);e("[exclude]").each(function(){var a=e(this);a.toggle(!u(t,a.attr("exclude")))}),e("[include]").each(function(){var a=e(this);a.toggle(u(t,a.attr("include")))});var i=function(e){var a=e.attr("select-day");a=!a||u(t,a);var n=u(t,e.attr("select-date"));return n&&a};e("input[select-date]").each(function(){var t=e(this),a=i(t);if(a)t.prop("checked",!0).change();else{var n=t.siblings("input[name="+t.attr("name")+"]");1!=n.length||n.is("[select-date]")||n.prop("checked",!0).change()}}),e("option[select-date]").each(function(){var t=e(this),a=i(t);if(a)t.parent().val(t.val()).change();else{var n=t.siblings("option");1!=n.length||n.is("[select-date]")||t.parent().val(n.val()).change()}});var l=n.isPaschalTime(t),c=0!==t.day();if(l&&n.isPaschalWeek(t))c=!1,Y(0,"no-antiphon",!0),x("-po"),e("#weekday").text("Easter "+R[t.day()]);else if(n.isTriduum(t)){c=!1;var h=t.day();Y("triduum");var p;switch(h){case 4:p="Maundy Thursday";break;case 5:p="Good Friday";break;case 6:p="Holy Saturday"}e("#weekday").text(p)}else u(t,"allSouls")?(c=!1,e("#weekday").text("All Souls Day"),Y("asd"),x("-asd")):(Y(t.day(),l),x(l?"-pt":""));e(".chooseDay").toggle(c);var g=e("#rbWeekday").prop("value",t.day());if(r.alternates){var m=e("#selectFeastDay");m.empty().append(r.alternates.map(function(e,t){return'<option value="'+(e.region&&e.region[0]||"")+'">'+e.title+(e.rank<5?" ("+B(e.rank)+")":"")+(e.region?" ["+e.region.join(", ")+"]":"")+"</option>"}).join("")),m.val(f)}else e("#feastDay").text(r.title+(r.rank<5?" ("+B(r.rank)+")":""));e("#feastDay").toggle(!r.alternates),e("#selectFeastDay").toggle(!!r.alternates),r&&r.rank<=2?e("#rbSunday").prop("checked",!0):g.prop("checked",!0),d()},H=function(e,t){e&&0!==e.length&&(e.attr("src",t),e.data("setSrc")(t))};e("input[name=weekday]").change(function(){this.checked&&Y(parseInt(this.value),"paschal"==W.season,!0)});var K=function(t,a,n){var r=t+"/"+a+".gabc";H(e("#"+t),r);var i=e("chant-gabc["+n+"]");i.length>0&&H(i,i.attr(n)),e("div."+t).hide(),e("div."+t+"."+a).show()},W={};e("[id$=-choices] input[type=radio]").change(function(){var e=this.name;W[e]=this.value,"season"!=e&&K(e,this.value,this.id)}),e("#marian-antiphon-choices select,#marian-antiphon-solemn").change(function(){var t=e("#marian-antiphon-choices select"),a=e("#marian-antiphon-solemn").prop("checked"),n="marian-antiphon",r=t.val(),i=t.find("option[value="+r+"]").prop("id");a&&(r+="-solemn",i+="-solemn"),W[n]=r,K(n,r,i)});var L=e("#date");L.change(function(){this.value&&j(moment(this.value))}).change(),e("#selectFeastDay").change(function(){f=this.value,j(moment(L.val()))})});