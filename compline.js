$(function(e){"use strict";function t(){e.getJSON("https://freegeoip.net/json/",function(e){if(e.country_code in romanCalendar.regionCodeMap)h.region=e.country_code;else{var t=e.country_code+"-"+e.region_code;t in romanCalendar.regionCodeMap?h.region=t:console.info("Unknown Region:",e)}console.info("Country: "+e.country_name+"\nCode: "+e.country_code),window.ipGeo=m=e})}function a(e){var t=Math.floor(e/100),a=e-19*Math.floor(e/19),n=Math.floor((t-17)/25),r=t-Math.floor(t/4)-Math.floor((t-n)/3)+19*a+15;r-=30*Math.floor(r/30),r-=Math.floor(r/28)*(1-Math.floor(r/28)*Math.floor(29/(r+1))*Math.floor((21-a)/11));var i=e+Math.floor(e/4)+r+2-t+Math.floor(t/4);i-=7*Math.floor(i/7);var s=r-i,o=3+Math.floor((s+40)/44),c=s+28-31*Math.floor(o/4);return moment([e,o-1,c])}function n(e){for(var t=s(e),a=0;a<CalendarSundays.length;++a){var n=CalendarSundays[a];if(n.on){if(e.isSame(c(n.on,e)))return SundayFeast(n,e,t)}else if(n.before){if(e.isBefore(c(n.before,e)))return SundayFeast(n,e,t)}else if(n.after&&e.isAfter(c(n.after,e)))return SundayFeast(n,e,t)}}function r(e,t){e&&!e.length&&(e=void 0);var a={title:"Feria",rank:10},n=a;return e&&e.length&&(e.unshift(a),t?(n=t,d=n.region[0]):d="",n.alternates=e),n}function i(t){if("liturgical"in t)return t.liturgical;if(0===t.day())return t.liturgical=n(t);if(l(t,"corpusChristi"))return t.liturgical={title:"Corpus Christi",rank:1};if(l(t,"sacredHeart"))return t.liturgical={title:"The Most Sacred Heart of Jesus",rank:1};if(l(t,"ascension"))return t.liturgical={title:"The Ascension of Our Lord",rank:1};if(l(t,"easter-3"))return t.liturgical={title:"Maundy Thursday",rank:1};if(l(t,"easter-2"))return t.liturgical={title:"Good Friday",rank:1};if(l(t,"easter-1"))return t.liturgical={title:"Holy Saturday",rank:1};if(l(t,"lent1-4"))return t.liturgical={title:"Ash Wednesday",rank:5};var a,i=[];if(regionalCalendars){var s=t.format("MM/DD"),o=moment(t).subtract(1,"day").format("MM/DD");e.each(regionalCalendars,function(n,r){var c;if(s in r)c=r[s];else if(o in r){var l=r[o];"ifSunday"===l.plusOne&&1===t.day()&&(c=l)}if(c){var u=n===d||romanCalendar.regionCodeMap[h.region]===n;c.region=[n];var f=e.grep(i,function(e,t){return e.title==c.title&&e.rank===c.rank});f.length?(f[0].region.push(n),u&&(a=f[0])):(i.push(c),u&&(a=c))}})}if(romanCalendar){var c=t.month(),u=t.date(),f=romanCalendar[c][u];if(!f&&u>1){if(f=romanCalendar[c][u-1],!f||!f.plus)return t.liturgical=r(i,a);if("ifLeapYear"===f.plusOne&&!t.isLeapYear())return t.liturgical=r(i,a);if("ifSunday"===f.plusOne&&1!==t.day())return t.liturgical=r(i,a)}if(i.length&&(i.unshift(f),a?(f=a,d=f.region[0]):d="",f.alternates=i),f)return t.liturgical=f}return t.liturgical=r(i,a)}function s(e){return e.Dates||(e.Dates=new b(e.year()))}function o(e,t,a){if(t[1])return moment([e.year(),parseInt(t[2])-1,parseInt(t[3])]);if(t[5]in a){var n=a[t[5]]||[0];if("function"==typeof n)return a[t[5]](e);var r=moment(n);if(t[7]){var i=parseInt(t[7])||0;"-"==t[6]&&(i*=-1),r.add(i,"days")}return r}return console.info("date not found: "+t[5]),moment("")}function c(e,t){var a=s(t),n=/(?:((\d\d)\/(\d\d))|((\w+)(?:([+-])(\d+))?))(?::(((\d\d)\/(\d\d))|((\w+)(?:([+-])(\d+))?)))?/g,r=n.exec(e);return o(t,r,a)}function l(e,t){for(var a,n,r=s(e),i=/(!)?(?:((\d\d)\/(\d\d))|((\w+)(?:([+-])(\d+))?))(?::(((\d\d)\/(\d\d))|((\w+)(?:([+-])(\d+))?)))?/g;a=i.exec(t);){var c=a[1],l=[o(e,a.slice(1),r)];if(a[9]){if(l.push(o(e,a.slice(9),r)),n=e.isBetween(l[0],l[1],"day","[]"),c&&(n=!n),n)return!0}else if("boolean"==typeof l[0]){if(c&&(l[0]=!l[0]),l[0])return!0}else if(n=e.isSame(l[0],"day"),c&&(n=!n),n)return!0}return!1}function u(){var t=y();e("input:radio:not(.not-hideable)").parent().toggle(t),e("#marian-antiphon-choices>select").toggle(t),e(".marian-antiphon-name").toggle(!t),t||e("input:radio:checked").parent().show()}var d="",h=window.localStorage;try{var f="__storage test__";h.setItem(f,f),h.removeItem(f)}catch(p){h={}}"region"in h||(h.region=""),"fullNotation"in h||(h.fullNotation="0"),"showOptions"in h||(h.showOptions="0"),"autoSelectRegion"in h||(h.autoSelectRegion="1");var m,g=function(e){return"undefined"==typeof e?!!parseInt(h.fullNotation):(h.fullNotation=e?1:0,A(),void I())},y=function(e){return"undefined"==typeof e?!!parseInt(h.showOptions):(h.showOptions=e?1:0,void u())};parseInt(h.autoSelectRegion)&&t();var v={},b=function(e){return e in v?v[e]:(this.year=e,this.easter=a(e),this.septuagesima=moment(this.easter).subtract(63,"days"),this.lent1=moment(this.septuagesima).add(21,"days"),this.ascension=moment(this.easter).add(39,"days"),this.pentecost=moment(this.easter).add(49,"days"),this.christmas=moment([e,11,25]),this.advent1=moment(this.christmas).subtract((this.christmas.day()||7)+21,"days"),this.allSouls=moment([e,10,2]),0===this.allSouls.day()&&this.allSouls.add(1,"day"),this.corpusChristi=moment(this.pentecost).add(11,"days"),this.sacredHeart=moment(this.pentecost).add(19,"days"),this.christTheKing=moment([e,9,31]),this.christTheKing.subtract(this.christTheKing.day(),"days"),this.sevenDolors=moment([e,8,15]),this.epiphany=moment([e,0,6]),this.holyFamily=moment(this.epiphany).add(7-(this.epiphany.day()||1),"days"),this.transfiguration=moment([e,7,6]),void(v[e]=this))};b.prototype.firstClassFeast=function(e){var t=i(e);return!(!t||1!==t.rank)},b.prototype.firstOrSecondClassFeast=function(e){var t=i(e);return!(!t||1!==t.rank&&2!==t.rank)},b.prototype.feastOfOurLady=function(e){var t=i(e);return!(!t||!t.ol)},b.prototype.minorFeast=function(e){var t=i(e);return t&&t.rank>1&&t.rank<5},b.prototype.feria=function(e){var t=i(e);return 0!==e.day()&&(!t||t.rank>=5)},b.prototype.sunday=function(e){return 0===e.day()},b.prototype.isTriduum=function(e){var t=moment(this.easter).subtract(3,"days");return e.isSameOrAfter(t)&&e.isBefore(this.easter)},b.prototype.isPaschalWeek=function(e){var t=moment(this.easter).add(6,"days");return e.isSameOrAfter(this.easter)&&e.isBefore(t)},b.prototype.isPaschalTime=function(e){var t=moment(this.easter).add(55,"days");return e.isSameOrAfter(this.easter)&&e.isBefore(t)},b.prototype.isAdvent=function(e){return e.isSameOrAfter(moment(this.advent1).subtract(1,"day"))&&e.isSameOrBefore(moment(this.christmas).subtract(1,"day"))},window.momentFromString=c,e.QueryString=function(e){if(""===e)return{};for(var t={},a=0;a<e.length;++a){var n=e[a].split("=");2==n.length&&(t[n[0]]=decodeURIComponent(n[1].replace(/\+/g," ")))}return t.successMsg&&showAlert(!1,t.successMsg),t.failMsg&&showAlert(!0,t.failMsg),t}(window.location.search.substr(1).split("&"));var k=moment();e("#date").val(k.format("YYYY-MM-DD"));var S=function(e){return function(t,a){var n=moment(a);return n.isValid()?n.add(e,"days"):n=moment(),n.format("YYYY-MM-DD")}},M=function(t){e("#date").val(S(t?7:1)).change()},w=function(t){e("#date").val(S(t?-7:-1)).change()};e(document).on("keypress",function(e){switch(e.which){case 106:case 74:w(e.shiftKey);break;case 107:case 75:M(e.shiftKey)}});var C,D=k.day(),O=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];if(e.QueryString.day){var T=e.QueryString.day;T in O?D=T:(T=O.indexOf(T),T in O&&(D=T))}var F="",I=function(t){t=t||F.replace(/_full$/,"");var a=t;if(g()&&(t+="_full"),t!==F){F=t;var n="<chant-gabc src='canticle-ant"+a+".gabc'></chant-gabc>";"-pt"===a&&(a="",t=t.slice(3));var r="<chant-gabc src='canticle-psalm"+t+".gabc'></chant-gabc>",i=function(t){var i=n+r+t;i+="-po"===a?"<chant-gabc src='haec-dies.gabc'></chant-gabc>":n,e("#canticle").empty().append(i)};e("#canticle").empty(),g()?i(""):e.get("canticle-psalm"+t+".html",i)}},_={},A=function(t,a,n){"undefined"==typeof t?(t=_.day,a=_.paschalTime,n=_.isSunday):(_.day=t,_.paschalTime=a,_.isSunday=n);var r="",i="",s="",o=g()?"_full":"";"triduum"===t?(t=0,s="-triduum",o=""):"asd"===t?(s="",i="<chant-gabc src='psalms/"+t+"/psalm"+s+o+".gabc'></chant-gabc>"):(s=a?"-PT":"",r=a?"<chant-gabc src='psalms/ant-PT.gabc'></chant-gabc>":"<chant-gabc src='psalms/"+t+"/ant.gabc'></chant-gabc>","no-antiphon"===a&&(r=""),i="<chant-gabc src='psalms/"+t+"/psalm"+s+o+".gabc'></chant-gabc>",C=O[t],n||e("#weekday").text(C));var c=function(t){var a=r+i+t+r;e("#placeholder").empty().append(a)};o?c(""):e.get("psalms/"+t+"/psalm-verses"+s+".html",c).fail(function(){e.get("psalms/"+t+"/psalm-verses.html",c)})},x=function(e){switch(e){case 1:return"I Class";case 2:return"II Class";case 3:return"III Class";case 5:return"Commemoration";default:return"Feria"}},Y=function(t,a){var n=s(t),r=i(t,a);e("[exclude]").each(function(){var a=e(this);a.toggle(!l(t,a.attr("exclude")))}),e("[include]").each(function(){var a=e(this);a.toggle(l(t,a.attr("include")))});var o=function(e){var a=e.attr("select-day");a=!a||l(t,a);var n=l(t,e.attr("select-date"));return n&&a};e("input[select-date]").each(function(){var t=e(this),a=o(t);if(a)t.prop("checked",!0).change();else{var n=t.siblings("input[name="+t.attr("name")+"]");1!=n.length||n.is("[select-date]")||n.prop("checked",!0).change()}}),e("option[select-date]").each(function(){var t=e(this),a=o(t);if(a)t.parent().val(t.val()).change();else{var n=t.siblings("option");1!=n.length||n.is("[select-date]")||t.parent().val(n.val()).change()}});var c=n.isPaschalTime(t),h=0!==t.day();if(c&&n.isPaschalWeek(t))h=!1,A(0,"no-antiphon",!0),I("-po"),e("#weekday").text("Easter "+O[t.day()]);else if(n.isTriduum(t)){h=!1;var f=t.day();A("triduum");var p;switch(f){case 4:p="Maundy Thursday";break;case 5:p="Good Friday";break;case 6:p="Holy Saturday"}e("#weekday").text(p)}else l(t,"allSouls")?(h=!1,e("#weekday").text("All Souls Day"),A("asd"),I("-asd")):(A(t.day(),c),I(c?"-pt":""));e(".chooseDay").toggle(h);var m=e("#rbWeekday").prop("value",t.day());if(r.alternates){var g=e("#selectFeastDay");g.empty().append(r.alternates.map(function(e,t){return'<option value="'+(e.region&&e.region[0]||"")+'">'+e.title+(e.rank<5?" ("+x(e.rank)+")":"")+(e.region?" ["+e.region.join(", ")+"]":"")+"</option>"}).join("")),g.val(d)}else e("#feastDay").text(r.title+(r.rank<5?" ("+x(r.rank)+")":""));e("#feastDay").toggle(!r.alternates),e("#selectFeastDay").toggle(!!r.alternates),r&&r.rank<=2?e("#rbSunday").prop("checked",!0):m.prop("checked",!0),u()},B=function(e,t){e&&0!==e.length&&(e.attr("src",t),e.data("setSrc")(t))};e("input[name=weekday]").change(function(){this.checked&&A(parseInt(this.value),"paschal"==H.season,!0)});var P=function(t,a,n){var r=t+"/"+a+".gabc";B(e("#"+t),r);var i=e("chant-gabc["+n+"]");i.length>0&&B(i,i.attr(n)),e("div."+t).hide(),e("div."+t+"."+a).show()},H={};e("[id$=-choices] input[type=radio]").change(function(){var e=this.name;H[e]=this.value,"season"!=e&&P(e,this.value,this.id)}),e("#marian-antiphon-choices select,#marian-antiphon-solemn").change(function(){var t=e("#marian-antiphon-choices select"),a=e("#marian-antiphon-solemn").prop("checked"),n="marian-antiphon",r=t.val(),i=t.find("option[value="+r+"]").prop("id");a&&(r+="-solemn",i+="-solemn"),H[n]=r,P(n,r,i)});var K=e("#date");K.change(function(){this.value&&Y(moment(this.value))}).change(),e("#selectFeastDay").change(function(){d=this.value,Y(moment(K.val()))})});