$(function(t){"use strict";function e(){t.getJSON("https://freegeoip.net/json/",function(t){if(t.country_code in romanCalendar.regionCodeMap)h.region=t.country_code;else{var e=t.country_code+"-"+t.region_code;e in romanCalendar.regionCodeMap?h.region=e:console.info("Unknown Region:",t)}console.info("Country: "+t.country_name+"\nCode: "+t.country_code),window.ipGeo=m=t})}function a(t){var e=Math.floor(t/100),a=t-19*Math.floor(t/19),n=Math.floor((e-17)/25),r=e-Math.floor(e/4)-Math.floor((e-n)/3)+19*a+15;r-=30*Math.floor(r/30),r-=Math.floor(r/28)*(1-Math.floor(r/28)*Math.floor(29/(r+1))*Math.floor((21-a)/11));var i=t+Math.floor(t/4)+r+2-e+Math.floor(e/4);i-=7*Math.floor(i/7);var s=r-i,o=3+Math.floor((s+40)/44),c=s+28-31*Math.floor(o/4);return moment([t,o-1,c])}function n(t){for(var e=s(t),a=0;a<CalendarSundays.length;++a){var n=CalendarSundays[a];if(n.on){if(t.isSame(c(n.on,t)))return SundayFeast(n,t,e)}else if(n.before){if(t.isBefore(c(n.before,t)))return SundayFeast(n,t,e)}else if(n.after&&t.isAfter(c(n.after,t)))return SundayFeast(n,t,e)}}function r(t,e){t&&!t.length&&(t=void 0);var a={title:"Feria",rank:10},n=a;return t&&t.length&&(t.unshift(a),e?(n=e,d=n.region[0]):d="",n.alternates=t),n}function i(e){if("liturgical"in e)return e.liturgical;if(0===e.day())return e.liturgical=n(e);if(l(e,"corpusChristi"))return e.liturgical={title:"Corpus Christi",rank:1};if(l(e,"sacredHeart"))return e.liturgical={title:"The Most Sacred Heart of Jesus",rank:1};if(l(e,"ascension"))return e.liturgical={title:"The Ascension of Our Lord",rank:1};if(l(e,"easter-3"))return e.liturgical={title:"Maundy Thursday",rank:1};if(l(e,"easter-2"))return e.liturgical={title:"Good Friday",rank:1};if(l(e,"easter-1"))return e.liturgical={title:"Holy Saturday",rank:1};if(l(e,"lent1-4"))return e.liturgical={title:"Ash Wednesday",rank:5};var a,i=[];if(regionalCalendars){var s=e.format("MM/DD"),o=moment(e).subtract(1,"day").format("MM/DD");t.each(regionalCalendars,function(n,r){var c;if(s in r)c=r[s];else if(o in r){var l=r[o];"ifSunday"===l.plusOne&&1===e.day()&&(c=l)}if(c){var u=n===d||romanCalendar.regionCodeMap[h.region]===n;c.region=[n];var f=t.grep(i,function(t,e){return t.title==c.title&&t.rank===c.rank});f.length?(f[0].region.push(n),u&&(a=f[0])):(i.push(c),u&&(a=c))}})}if(romanCalendar){var c=e.month(),u=e.date(),f=romanCalendar[c][u];if(!f&&u>1){if(f=romanCalendar[c][u-1],!f||!f.plus)return e.liturgical=r(i,a);if("ifLeapYear"===f.plusOne&&!e.isLeapYear())return e.liturgical=r(i,a);if("ifSunday"===f.plusOne&&1!==e.day())return e.liturgical=r(i,a)}if(i.length&&(i.unshift(f),a?(f=a,d=f.region[0]):d="",f.alternates=i),f)return e.liturgical=f}return e.liturgical=r(i,a)}function s(t){return t.Dates||(t.Dates=new b(t.year()))}function o(t,e,a){if(e[1])return moment([t.year(),parseInt(e[2])-1,parseInt(e[3])]);if(e[5]in a){var n=a[e[5]]||[0];if("function"==typeof n)return a[e[5]](t);var r=moment(n);if(e[7]){var i=parseInt(e[7])||0;"-"==e[6]&&(i*=-1),r.add(i,"days")}return r}return console.info("date not found: "+e[5]),moment("")}function c(t,e){var a=s(e),n=/(?:((\d\d)\/(\d\d))|((\w+)(?:([+-])(\d+))?))(?::(((\d\d)\/(\d\d))|((\w+)(?:([+-])(\d+))?)))?/g,r=n.exec(t);return o(e,r,a)}function l(t,e){for(var a,n,r=s(t),i=/(!)?(?:((\d\d)\/(\d\d))|((\w+)(?:([+-])(\d+))?))(?::(((\d\d)\/(\d\d))|((\w+)(?:([+-])(\d+))?)))?/g;a=i.exec(e);){var c=a[1],l=[o(t,a.slice(1),r)];if(a[9]){if(l.push(o(t,a.slice(9),r)),n=t.isBetween(l[0],l[1],"day","[]"),c&&(n=!n),n)return!0}else if("boolean"==typeof l[0]){if(c&&(l[0]=!l[0]),l[0])return!0}else if(n=t.isSame(l[0],"day"),c&&(n=!n),n)return!0}return!1}function u(){var e=g();t("input:radio:not(.not-hideable)").parent().toggle(e),e||t("input:radio:checked").parent().show()}var d="",h=window.localStorage;try{var f="__storage test__";h.setItem(f,f),h.removeItem(f)}catch(p){h={}}"region"in h||(h.region=""),"fullNotation"in h||(h.fullNotation="0"),"showOptions"in h||(h.showOptions="0"),"autoSelectRegion"in h||(h.autoSelectRegion="1");var m,y=function(t){return"undefined"==typeof t?!!parseInt(h.fullNotation):(h.fullNotation=t?1:0,A(),void I())},g=function(t){return"undefined"==typeof t?!!parseInt(h.showOptions):(h.showOptions=t?1:0,void u())};parseInt(h.autoSelectRegion)&&e();var v={},b=function(t){return t in v?v[t]:(this.year=t,this.easter=a(t),this.septuagesima=moment(this.easter).subtract(63,"days"),this.lent1=moment(this.septuagesima).add(21,"days"),this.ascension=moment(this.easter).add(39,"days"),this.pentecost=moment(this.easter).add(49,"days"),this.christmas=moment([t,11,25]),this.advent1=moment(this.christmas).subtract((this.christmas.day()||7)+21,"days"),this.allSouls=moment([t,10,2]),0===this.allSouls.day()&&this.allSouls.add(1,"day"),this.corpusChristi=moment(this.pentecost).add(11,"days"),this.sacredHeart=moment(this.pentecost).add(19,"days"),this.christTheKing=moment([t,9,31]),this.christTheKing.subtract(this.christTheKing.day(),"days"),this.sevenDolors=moment([t,8,15]),this.epiphany=moment([t,0,6]),this.holyFamily=moment(this.epiphany).add(7-(this.epiphany.day()||1),"days"),this.transfiguration=moment([t,7,6]),void(v[t]=this))};b.prototype.firstClassFeast=function(t){var e=i(t);return!(!e||1!==e.rank)},b.prototype.firstOrSecondClassFeast=function(t){var e=i(t);return!(!e||1!==e.rank&&2!==e.rank)},b.prototype.feastOfOurLady=function(t){var e=i(t);return!(!e||!e.ol)},b.prototype.minorFeast=function(t){var e=i(t);return e&&e.rank>1&&e.rank<5},b.prototype.feria=function(t){var e=i(t);return 0!==t.day()&&(!e||e.rank>=5)},b.prototype.sunday=function(t){return 0===t.day()},b.prototype.isTriduum=function(t){var e=moment(this.easter).subtract(3,"days");return t.isSameOrAfter(e)&&t.isBefore(this.easter)},b.prototype.isPaschalWeek=function(t){var e=moment(this.easter).add(6,"days");return t.isSameOrAfter(this.easter)&&t.isBefore(e)},b.prototype.isPaschalTime=function(t){var e=moment(this.easter).add(55,"days");return t.isSameOrAfter(this.easter)&&t.isBefore(e)},b.prototype.isAdvent=function(t){return t.isSameOrAfter(moment(this.advent1).subtract(1,"day"))&&t.isSameOrBefore(moment(this.christmas).subtract(1,"day"))},window.momentFromString=c,t.QueryString=function(t){if(""===t)return{};for(var e={},a=0;a<t.length;++a){var n=t[a].split("=");2==n.length&&(e[n[0]]=decodeURIComponent(n[1].replace(/\+/g," ")))}return e.successMsg&&showAlert(!1,e.successMsg),e.failMsg&&showAlert(!0,e.failMsg),e}(window.location.search.substr(1).split("&"));var k=moment();t("#date").val(k.format("YYYY-MM-DD"));var S=function(t){return function(e,a){var n=moment(a);return n.isValid()?n.add(t,"days"):n=moment(),n.format("YYYY-MM-DD")}},M=function(e){t("#date").val(S(e?7:1)).change()},w=function(e){t("#date").val(S(e?-7:-1)).change()};t(document).on("keypress",function(t){switch(t.which){case 106:case 74:w(t.shiftKey);break;case 107:case 75:M(t.shiftKey)}});var C,D=k.day(),O=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];if(t.QueryString.day){var T=t.QueryString.day;T in O?D=T:(T=O.indexOf(T),T in O&&(D=T))}var F="",I=function(e){e=e||F.replace(/_full$/,"");var a=e;if(y()&&(e+="_full"),e!==F){F=e;var n="<chant-gabc src='canticle-ant"+a+".gabc'></chant-gabc>";"-pt"===a&&(a="",e=e.slice(3));var r="<chant-gabc src='canticle-psalm"+e+".gabc'></chant-gabc>",i=function(e){var i=n+r+e;i+="-po"===a?"<chant-gabc src='haec-dies.gabc'></chant-gabc>":n,t("#canticle").empty().append(i)};t("#canticle").empty(),y()?i(""):t.get("canticle-psalm"+e+".html",i)}},_={},A=function(e,a,n){"undefined"==typeof e?(e=_.day,a=_.paschalTime,n=_.isSunday):(_.day=e,_.paschalTime=a,_.isSunday=n);var r="",i="",s="",o=y()?"_full":"";"triduum"===e?(e=0,s="-triduum",o=""):"asd"===e?(s="",i="<chant-gabc src='psalms/"+e+"/psalm"+s+o+".gabc'></chant-gabc>"):(s=a?"-PT":"",r=a?"<chant-gabc src='psalms/ant-PT.gabc'></chant-gabc>":"<chant-gabc src='psalms/"+e+"/ant.gabc'></chant-gabc>","no-antiphon"===a&&(r=""),i="<chant-gabc src='psalms/"+e+"/psalm"+s+o+".gabc'></chant-gabc>",C=O[e],n||t("#weekday").text(C));var c=function(e){var a=r+i+e+r;t("#placeholder").empty().append(a)};o?c(""):t.get("psalms/"+e+"/psalm-verses"+s+".html",c).fail(function(){t.get("psalms/"+e+"/psalm-verses.html",c)})},x=function(t){switch(t){case 1:return"I Class";case 2:return"II Class";case 3:return"III Class";case 5:return"Commemoration";default:return"Feria"}},Y=function(e,a){var n=s(e),r=i(e,a);t("[exclude]").each(function(){var a=t(this);a.toggle(!l(e,a.attr("exclude")))}),t("[include]").each(function(){var a=t(this);a.toggle(l(e,a.attr("include")))});var o=function(t){var a=t.attr("select-day");a=!a||l(e,a);var n=l(e,t.attr("select-date"));return n&&a};t("input[select-date]").each(function(){var e=t(this),a=o(e);if(a)e.prop("checked",!0).change();else{var n=e.siblings("input[name="+e.attr("name")+"]");1!=n.length||n.is("[select-date]")||n.prop("checked",!0).change()}}),t("option[select-date]").each(function(){var e=t(this),a=o(e);if(a)e.parent().val(e.val()).change();else{var n=e.siblings("option");1!=n.length||n.is("[select-date]")||e.parent().val(n.val()).change()}});var c=n.isPaschalTime(e),h=0!==e.day();if(c&&n.isPaschalWeek(e))h=!1,A(0,"no-antiphon",!0),I("-po"),t("#weekday").text("Easter "+O[e.day()]);else if(n.isTriduum(e)){h=!1;var f=e.day();A("triduum");var p;switch(f){case 4:p="Maundy Thursday";break;case 5:p="Good Friday";break;case 6:p="Holy Saturday"}t("#weekday").text(p)}else l(e,"allSouls")?(h=!1,t("#weekday").text("All Souls Day"),A("asd"),I("-asd")):(A(e.day(),c),I(c?"-pt":""));t(".chooseDay").toggle(h);var m=t("#rbWeekday").prop("value",e.day());if(r.alternates){var y=t("#selectFeastDay");y.empty().append(r.alternates.map(function(t,e){return'<option value="'+(t.region&&t.region[0]||"")+'">'+t.title+(t.rank<5?" ("+x(t.rank)+")":"")+(t.region?" ["+t.region.join(", ")+"]":"")+"</option>"}).join("")),y.val(d)}else t("#feastDay").text(r.title+(r.rank<5?" ("+x(r.rank)+")":""));t("#feastDay").toggle(!r.alternates),t("#selectFeastDay").toggle(!!r.alternates),r&&r.rank<=2?t("#rbSunday").prop("checked",!0):m.prop("checked",!0),u()},B=function(t,e){t&&0!==t.length&&(t.attr("src",e),t.data("setSrc")(e))};t("input[name=weekday]").change(function(){this.checked&&A(parseInt(this.value),"paschal"==H.season,!0)});var P=function(e,a,n){var r=e+"/"+a+".gabc";B(t("#"+e),r);var i=t("chant-gabc["+n+"]");i.length>0&&B(i,i.attr(n)),t("div."+e).hide(),t("div."+e+"."+a).show()},H={};t("[id$=-choices] input[type=radio]").change(function(){var t=this.name;H[t]=this.value,"season"!=t&&P(t,this.value,this.id)}),t("#marian-antiphon-choices select,#marian-antiphon-solemn").change(function(){var e=t("#marian-antiphon-choices select"),a=t("#marian-antiphon-solemn").prop("checked"),n="marian-antiphon",r=e.val(),i=e.find("option[value="+r+"]").prop("id");a&&(r+="-solemn",i+="-solemn"),H[n]=r,P(n,r,i)});var K=t("#date");K.change(function(){this.value&&Y(moment(this.value))}).change(),t("#selectFeastDay").change(function(){d=this.value,Y(moment(K.val()))})});