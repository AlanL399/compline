define(["jquery","exsurge","document-register-element"],function(t,e){"use strict";var n=/((?:[\w-_]+:\s*[^;\r\n]*;?\r?\n)+)%%\r?\n/,i=window.document.body.clientWidth,a=function(){i=window.document.body.clientWidth,t("chant-gabc").each(function(){this.doLayout(i)})};window.addEventListener?window.addEventListener("resize",a,!1):window.attachEvent&&window.attachEvent("onresize",a);var r=Object.create(HTMLElement.prototype);r.setSrc=function(e){var n=this,i=t(this);if(e=e||i.attr("src")){this._width=0;var a=new XMLHttpRequest;a.onreadystatechange=function(){4===a.readyState&&200===a.status&&i.attr("src")===e&&n.setGabc(a.responseText)},a.open("GET",e,!0),a.send(null)}},r.doLayout=function(t){var e=this._score,n=this._ctxt;if(t=t||this.parentElement&&this.parentElement.clientWidth||window.document.body.clientWidth,0!==t&&this._width!==t){for(var i=this._width=t,a="",r=0;r<e.length;++r)(e[r].userNotes||e[r].commentary)&&(a+="<br>"),e[r].userNotes&&(a+="<i>"+e[r].userNotes+"</i>"),e[r].commentary&&(a+='<i style="float:right">'+e[r].commentary+"</i>"),e[r].performLayout(n),e[r].layoutChantLines(n,i),a+=e[r].createSvg(n);this.innerHTML=a}},r.setGabc=function(t,a){var r=[],o=this.getAttribute("use-drop-cap");o="false"!==o;var s=this._mappings=[],c=this._score=[],h=this._ctxt;t=t.replace(/<v>\\([VRA])bar<\/v>/g,function(t,e){return e+"/."}).replace(/(<b>[^<]+)<sp>'(?:oe|œ)<\/sp>/g,"$1œ</b>́<b>").replace(/<b><\/b>/g,"").replace(/<sp>'(?:ae|æ)<\/sp>/g,"ǽ").replace(/<sp>'(?:oe|œ)<\/sp>/g,"œ́").replace(/<v>\\greheightstar<\/v>/g,"*");var l=t.split(n);1===l.length&&l.splice(0,"","");for(var u=(l.length-1)/2,d=0;d<u;++d){var p=l[2*d+1].split(/\r?\n/);t=l[2*d+2].replace(/([^c])u([aeiouáéíóú])/g,"$1u{$2}").replace(/<\/?sc>/g,"%").replace(/<\/?b>/g,"*").replace(/<\/?i>/g,"_").replace(/(\s)_([^\s*]+)_(\(\))?(\s)/g,"$1^_$2_^$3$4").replace(/(\([cf][1-4]\)|\s)(\d+\.)(\s\S)/g,"$1^$2^$3"),s[d]=e.Gabc.createMappingsFromSource(h,t),p&&(p=p.reduce(function(t,e){var n=e.match(/^%?([\w-_]+):\s*([^;\r\n]*)(?:;|$)/i);return n&&(t[n[1]]=n[2]),t},{}),"initial-style"in p&&(r[d]="1"===p["initial-style"])),d in r||(r[d]=o),c[d]=new e.ChantScore(h,s[d],r[d]),p&&p.annotation&&r[d]?c[d].annotation=new e.Annotation(h,p.annotation):a&&(c[d].annotation=new e.Annotation(h,a)),p&&p["user-notes"]&&(c[d].userNotes=p["user-notes"]),p&&p.commentary&&(c[d].commentary=p.commentary)}this.doLayout(i)},r.createdCallback=function(){var t=new e.ChantContext;t.lyricTextFont="'Crimson Text', serif",t.lyricTextSize*=1.2,t.dropCapTextFont=t.lyricTextFont,t.annotationTextFont=t.lyricTextFont,this._ctxt=t;var n=this.getAttribute("src");n?this.setSrc(n):setGabc(this.innerText,this.getAttribute("annotation")),this._width=0,this._attached=!1},r.attachedCallback=function(){this._attached=!0};document.registerElement("chant-gabc",{prototype:r})});