require(["jquery","moment","calendar","chant-element"],function(e,a,t){"use strict";function n(a,t){if("undefined"==typeof t){var n=e("input[toggle="+a+"]");t=p[a](),n.prop("checked",t)}switch(a){case"autoSelectRegion":e("#selectRegion").prop("disabled",t);break;case"fullNotationPrayers":e(".notated-prayer").toggle(t),e(".pointed-prayer").toggle(!t);break;case"fullNotationChapter":e(".notated-chapter").toggle(t),e(".pointed-chapter").toggle(!t)}}function o(){e.getJSON("https://freegeoip.net/json/",function(e){if(e.country_code in t.roman.regionCodeMap)f(e.country_code);else{var a=e.country_code+"-"+e.region_code;a in t.roman.regionCodeMap?f(a):console.info("Unknown Region:",e)}console.info("Country: "+e.country_name+"\nCode: "+e.country_code),window.ipGeo=v=e})}function i(){var a=g();e("input:radio:not(.not-hideable)").parent().toggle(a),e("#marian-antiphon-choices>select").toggle(a),e(".marian-antiphon-name").toggle(!a),a||e("input:radio:checked").parent().show()}var r="",c=window.localStorage;try{var s="__storage test__";c.setItem(s,s),c.removeItem(s)}catch(l){c={}}"region"in c||(c.region=""),"fullNotation"in c||(c.fullNotation="0"),"fullNotationChapter"in c||(c.fullNotationChapter="1"),"fullNotationPrayers"in c||(c.fullNotationPrayers="0"),"showOptions"in c||(c.showOptions="0"),"autoSelectRegion"in c||(c.autoSelectRegion="1");var u={};e("#selectRegion").append('<option value="">None</option>'+Object.keys(t.roman.regionCodeMap).map(function(e){var a=t.roman.regionCodeMap[e];return a in u?"":(u[a]="",'<option value="'+e+'"">'+a+"</option>")}).join("")).val(c.region);var d=e("#options-menu");e(document.body).click(function(a){var t=e(a.target);t.parents().is(d)?t.is("a,input,select,label")||d.toggleClass("showing"):d.removeClass("showing")});var p={},h=p.fullNotation=function(e){return"undefined"==typeof e?!!parseInt(c.fullNotation):(n("fullNotation",!!e),c.fullNotation=e?1:0,_(),void I())},g=(p.fullNotationChapter=function(e){return"undefined"==typeof e?!!parseInt(c.fullNotationChapter):(n("fullNotationChapter",!!e),void(c.fullNotationChapter=e?1:0))},p.fullNotationPrayers=function(e){return"undefined"==typeof e?!!parseInt(c.fullNotationPrayers):(n("fullNotationPrayers",!!e),void(c.fullNotationPrayers=e?1:0))},p.showOptions=function(e){return"undefined"==typeof e?!!parseInt(c.showOptions):(n("showOptions",!!e),c.showOptions=e?1:0,void i())}),f=(p.autoSelectRegion=function(e){return"undefined"==typeof e?!!parseInt(c.autoSelectRegion):(n("autoSelectRegion",!!e),c.autoSelectRegion=e?1:0,void(e&&o()))},function(a){return"undefined"==typeof a?!!parseInt(c.autoSelectRegion):(e("#selectRegion").val(a),r="",void(c.region=e("#selectRegion").val()))});e("input[toggle]").change(function(a){var t=e(this),n=p[t.attr("toggle")];n(this.checked)}),e("#selectRegion").change(function(a){f(e(this).val())}),e.each(p,function(e){n(e)});var v;parseInt(c.autoSelectRegion)&&o(),e.QueryString=function(e){if(""===e)return{};for(var a={},t=0;t<e.length;++t){var n=e[t].split("=");2==n.length&&(a[n[0]]=decodeURIComponent(n[1].replace(/\+/g," ")))}return a.successMsg&&showAlert(!1,a.successMsg),a.failMsg&&showAlert(!0,a.failMsg),a}(window.location.search.substr(1).split("&"));var y=a();e("#date").val(y.format("YYYY-MM-DD"));var m=function(e){return function(t,n){var o=a(n);return o.isValid()?o.add(e,"days"):o=a(),o.format("YYYY-MM-DD")}},b=function(a){e("#date").val(m(a?7:1)).change()},k=function(a){e("#date").val(m(a?-7:-1)).change()};e(document).on("keypress",function(e){switch(e.which){case 106:case 74:k(e.shiftKey);break;case 107:case 75:b(e.shiftKey)}});var w,S=y.day(),N=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];if(e.QueryString.day){var C=e.QueryString.day;C in N?S=C:(C=N.indexOf(C),C in N&&(S=C))}var M="",I=function(a){a="undefined"==typeof a?M.replace(/_full$/,""):a;var t=a;if(h()&&(a+="_full"),a!==M){M=a;var n="<chant-gabc src='canticle-ant"+t+".gabc'></chant-gabc>";"-pt"===t&&(t="",a=a.slice(3));var o="<chant-gabc src='canticle-psalm"+a+".gabc'></chant-gabc>",i=function(a){var i=n+o+a;i+="-po"===t?"<chant-gabc src='haec-dies.gabc'></chant-gabc>":n,e("#canticle").empty().append(i)};e("#canticle").empty(),h()?i(""):e.get("canticle-psalm"+a+".html",i)}},R={},_=function(a,t,n){if("undefined"==typeof a?(a=R.day,t=R.paschalTime,n=R.isSunday):(R.day=a,R.paschalTime=t,R.isSunday=n),!("undefined"==typeof a&&"undefined"==typeof t&&"undefined"==typeof n||R.day==a&&R.paschalTime==t&&R.isSunday==n&&R.full==h())){R.fullNotation=h();var o="",i="",r="",c=h()?"_full":"";"triduum"===a?(a=0,r="-triduum",c=""):"asd"===a?(r="",i="<chant-gabc src='psalms/"+a+"/psalm"+r+c+".gabc'></chant-gabc>"):(r=t?"-PT":"",o=t?"<chant-gabc src='psalms/ant-PT.gabc'></chant-gabc>":"<chant-gabc src='psalms/"+a+"/ant.gabc'></chant-gabc>","no-antiphon"===t&&(o=""),i="<chant-gabc src='psalms/"+a+"/psalm"+r+c+".gabc'></chant-gabc>",w=N[a],n||e("#weekday").text(w));var s=function(a){var t=o+i+a+o;e("#placeholder").empty().append(t)};c?s(""):e.get("psalms/"+a+"/psalm-verses"+r+".html",s).fail(function(){e.get("psalms/"+a+"/psalm-verses.html",s)})}},D=function(e){switch(e){case 1:return"I Class";case 2:return"II Class";case 3:return"III Class";case 5:return"Commemoration";default:return"Feria"}},P=function(a,n){var o=t.datesForMoment(a),c=t.getFeastForDate(a,n);e("[exclude]").each(function(){var n=e(this);n.toggle(!t.dateMatches(a,n.attr("exclude")))}),e("[include]").each(function(){var n=e(this);n.toggle(t.dateMatches(a,n.attr("include")))});var s=function(e){var n=e.attr("select-day");n=!n||t.dateMatches(a,n);var o=t.dateMatches(a,e.attr("select-date"));return o&&n};e("input[select-date]").each(function(){var a=e(this),t=s(a);if(t)a.prop("checked",!0).change();else{var n=a.siblings("input[name="+a.attr("name")+"]");1!=n.length||n.is("[select-date]")||n.prop("checked",!0).change()}}),e("option[select-date]").each(function(){var a=e(this),t=s(a);if(t)a.parent().val(a.val()).change();else{var n=a.siblings("option");1!=n.length||n.is("[select-date]")||a.parent().val(n.val()).change()}});var l=o.isPaschalTime(a),u=0!==a.day();if(l&&o.isPaschalWeek(a))u=!1,_(0,"no-antiphon",!0),I("-po"),e("#weekday").text("Easter "+N[a.day()]);else if(o.isTriduum(a)){u=!1;var d=a.day();_("triduum");var p;switch(d){case 4:p="Maundy Thursday";break;case 5:p="Good Friday";break;case 6:p="Holy Saturday"}e("#weekday").text(p)}else t.dateMatches(a,"allSouls")?(u=!1,e("#weekday").text("All Souls Day"),_("asd"),I("-asd")):(_(a.day(),l),I(l?"-pt":""));e(".chooseDay").toggle(u);var h=e("#rbWeekday").prop("value",a.day());if(c.alternates){var g=e("#selectFeastDay");g.empty().append(c.alternates.map(function(e,a){return'<option value="'+(e.region&&e.region[0]||"")+'">'+e.title+(e.rank<5?" ("+D(e.rank)+")":"")+(e.region?" ["+e.region.join(", ")+"]":"")+"</option>"}).join("")),g.val(r)}else e("#feastDay").text(c.title+(c.rank<5?" ("+D(c.rank)+")":""));e("#feastDay").toggle(!c.alternates),e("#selectFeastDay").toggle(!!c.alternates),c&&c.rank<=2?e("#rbSunday").prop("checked",!0):h.prop("checked",!0),i()},T=function(e,a){e&&0!==e.length&&(e.attr("src",a),e.get(0).setSrc(a))};e("input[name=weekday]").change(function(){this.checked&&_(parseInt(this.value),"paschal"==O.season,!0)});var F=function(a,t,n){var o=a+"/"+t+".gabc";T(e("#"+a),o);var i=e("chant-gabc["+n+"]");i.length>0&&T(i,i.attr(n)),e("div."+a).hide(),e("div."+a+"."+t).show()},O={};e("[id$=-choices] input[type=radio]").change(function(){var e=this.name;O[e]=this.value,"season"!=e&&F(e,this.value,this.id)}),e("#marian-antiphon-choices select,#marian-antiphon-solemn").change(function(){var a=e("#marian-antiphon-choices select"),t=e("#marian-antiphon-solemn").prop("checked"),n="marian-antiphon",o=a.val(),i=a.find("option[value="+o+"]").prop("id");t&&(o+="-solemn",i+="-solemn"),O[n]=o,F(n,o,i)});var x=e("#date");x.change(function(){this.value&&P(a(this.value))}).change(),e("#selectFeastDay").change(function(){r=this.value,P(a(x.val()))})});